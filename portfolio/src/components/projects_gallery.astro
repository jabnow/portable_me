---
import { readFileSync } from 'fs';
import { join } from 'path';
import { existsSync } from 'fs';

// Read and parse projects from project.txt
function parseProjectFile(): Array<{
  id: number;
  title: string;
  description: string;
  image: string;
  year: string;
  status: string;
  tags: string[];
  publications: number;
  link: string;
}> {
  // Try multiple possible paths (works in both dev and build)
  const projectRoot = process.cwd();
  const possiblePaths = [
    join(projectRoot, 'src', 'description', 'project.txt'),
    join(projectRoot, '..', 'src', 'description', 'project.txt'),
  ];
  
  let projectPath = possiblePaths.find(path => existsSync(path));
  if (!projectPath) {
    // Fallback: assume we're in project root
    projectPath = join(projectRoot, 'src', 'description', 'project.txt');
  }
  
  const projectContent = readFileSync(projectPath, 'utf-8');
  
  const projects: Array<{
    id: number;
    title: string;
    description: string;
    image: string;
    year: string;
    status: string;
    tags: string[];
    publications: number;
    link: string;
  }> = [];
  
  // Split by project separator (regex matches "=== Project N ===" at start of line)
  const parts = projectContent.split(/^=== Project \d+ ===$/m);
  
  // Skip the first part (header/comments) and process each project block
  for (let i = 1; i < parts.length; i++) {
    const block = parts[i].trim();
    if (!block) continue;
    
    const lines = block.split('\n');
    const project: {
      id: number;
      title: string;
      description: string;
      image: string;
      year: string;
      status: string;
      tags: string[];
      publications: number;
      link: string;
    } = {
      id: i,
      title: '',
      description: '',
      image: '',
      year: '',
      status: '',
      tags: [],
      publications: 0,
      link: '#'
    };
    
    let descriptionLines: string[] = [];
    let inDescription = false;
    
    for (const line of lines) {
      const trimmedLine = line.trim();
      
      // Skip empty lines and comments
      if (!trimmedLine || trimmedLine.startsWith('#')) {
        continue;
      }
      
      // Check if this is a field label
      if (trimmedLine.startsWith('Title:')) {
        inDescription = false;
        project.title = trimmedLine.substring(6).trim();
      } else if (trimmedLine.startsWith('Description:')) {
        inDescription = true;
        // Description might be on the same line or following lines
        const descText = trimmedLine.substring(12).trim();
        if (descText) {
          descriptionLines.push(descText);
        }
      } else if (trimmedLine.startsWith('Image:')) {
        inDescription = false;
        project.image = trimmedLine.substring(6).trim();
      } else if (trimmedLine.startsWith('Year:')) {
        inDescription = false;
        project.year = trimmedLine.substring(5).trim();
      } else if (trimmedLine.startsWith('Status:')) {
        inDescription = false;
        project.status = trimmedLine.substring(7).trim();
      } else if (trimmedLine.startsWith('Tags:')) {
        inDescription = false;
        const tagsStr = trimmedLine.substring(5).trim();
        project.tags = tagsStr.split(',').map(tag => tag.trim()).filter(tag => tag);
      } else if (trimmedLine.startsWith('Publications:')) {
        inDescription = false;
        const pubsStr = trimmedLine.substring(13).trim();
        project.publications = parseInt(pubsStr) || 0;
      } else if (trimmedLine.startsWith('Link:')) {
        inDescription = false;
        project.link = trimmedLine.substring(5).trim();
      } else if (inDescription && trimmedLine) {
        // Collect description lines (can be multiple lines)
        descriptionLines.push(trimmedLine);
      }
    }
    
    // Join description lines with spaces
    project.description = descriptionLines.join(' ').trim();
    
    // Only add if we have at least a title
    if (project.title) {
      projects.push(project);
    }
  }
  
  return projects;
}

const projects = parseProjectFile();

// Sort projects by year (most recent first)
const sortedProjects = [...projects].sort((a, b) => {
  const yearA = parseInt(a.year);
  const yearB = parseInt(b.year);
  return yearB - yearA;
});

---

<div class="projects-gallery">
  <div class="gallery-grid">
    {sortedProjects.map(project => (
      <article class="project-card" id={`project-${project.id}`}>
        <a href={project.link} class="project-link">
          <div class="project-image-container">
            <img 
              src={project.image || "/placeholder.svg"} 
              alt={project.title}
              class="project-image"
            />
            <div class="project-overlay">
              <span class="view-project">View Project â†’</span>
            </div>
          </div>
          
          <div class="project-content">
            <div class="project-meta">
              <span class="project-year">{project.year}</span>
              <span class={`project-status status-${project.status}`}>
                {project.status}
              </span>
            </div>
            
            <h3 class="project-title">{project.title}</h3>
            <p class="project-description">{project.description}</p>
            
            <div class="project-footer">
              <div class="project-tags">
                {project.tags.slice(0, 3).map(tag => (
                  <span class="tag">{tag}</span>
                ))}
              </div>
              
              <div class="project-publications">
                <svg class="pub-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"/>
                  <path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"/>
                </svg>
                {project.publications} {project.publications === 1 ? 'publications' : 'publications'}
              </div>
            </div>
          </div>
        </a>
      </article>
    ))}
  </div>
</div>

<style>
  .projects-gallery {
    margin-top: var(--spacing-2xl);
    margin-bottom: var(--spacing-3xl);
  }
  
  .gallery-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
    gap: var(--spacing-xl);
  }
  
  .project-card {
    background-color: var(--color-surface);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-lg);
    overflow: hidden;
    transition: all var(--transition-base);
  }
  
  .project-card:hover {
    transform: translateY(-8px);
    border-color: var(--color-primary);
    box-shadow: 0 20px 40px rgba(96, 165, 250, 0.2);
  }
  
  .project-link {
    display: block;
    color: inherit;
  }
  
  .project-image-container {
    position: relative;
    aspect-ratio: 16/10;
    overflow: hidden;
    background-color: var(--color-surface-elevated);
  }
  
  .project-image {
    width: 100%;
    height: 100%;
    object-fit: cover;
    transition: transform var(--transition-slow);
  }
  
  .project-card:hover .project-image {
    transform: scale(1.05);
  }
  
  .project-overlay {
    position: absolute;
    inset: 0;
    background: linear-gradient(to top, rgba(10, 14, 26, 0.9), transparent);
    display: flex;
    align-items: flex-end;
    justify-content: center;
    padding: var(--spacing-lg);
    opacity: 0;
    transition: opacity var(--transition-base);
  }
  
  .project-card:hover .project-overlay {
    opacity: 1;
  }
  
  .view-project {
    color: var(--color-primary);
    font-weight: 600;
    font-size: 1rem;
  }
  
  .project-content {
    padding: var(--spacing-xl);
  }
  
  .project-meta {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: var(--spacing-md);
  }
  
  .project-year {
    font-family: var(--font-mono);
    font-size: 0.85rem;
    color: var(--color-text-tertiary);
  }
  
  .project-status {
    font-size: 0.75rem;
    font-weight: 600;
    text-transform: uppercase;
    padding: 0.25rem 0.75rem;
    border-radius: var(--radius-sm);
    letter-spacing: 0.05em;
  }
  
  .status-ongoing {
    background-color: rgba(52, 211, 153, 0.2);
    color: var(--color-accent);
  }
  
  .status-completed {
    background-color: rgba(96, 165, 250, 0.2);
    color: var(--color-primary);
  }
  
  .project-title {
    font-size: 1.35rem;
    margin-bottom: var(--spacing-sm);
    color: var(--color-text-primary);
    line-height: 1.3;
  }
  
  .project-description {
    font-size: 0.95rem;
    line-height: 1.6;
    margin-bottom: var(--spacing-lg);
    color: var(--color-text-secondary);
  }
  
  .project-footer {
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: var(--spacing-md);
    padding-top: var(--spacing-md);
    border-top: 1px solid var(--color-border);
  }
  
  .project-tags {
    display: flex;
    flex-wrap: wrap;
    gap: var(--spacing-xs);
    flex: 1;
  }
  
  .tag {
    font-size: 0.75rem;
    padding: 0.25rem 0.65rem;
    background-color: var(--color-surface-elevated);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-sm);
    color: var(--color-text-secondary);
    white-space: nowrap;
  }
  
  .project-publications {
    display: flex;
    align-items: center;
    gap: var(--spacing-xs);
    font-size: 0.85rem;
    color: var(--color-text-tertiary);
    white-space: nowrap;
  }
  
  .pub-icon {
    flex-shrink: 0;
  }
  
  @media (max-width: 768px) {
    .gallery-grid {
      grid-template-columns: 1fr;
    }
    
    .project-footer {
      flex-direction: column;
      align-items: flex-start;
    }
  }
  
  @media (min-width: 1200px) {
    .gallery-grid {
      grid-template-columns: repeat(3, 1fr);
    }
  }
</style>

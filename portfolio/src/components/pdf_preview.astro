<div class="pdf-preview-container">
  <button id="resumePreviewBtn" class="resume-preview-btn">
    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
      <polyline points="14 2 14 8 20 8"/>
      <line x1="16" y1="13" x2="8" y2="13"/>
      <line x1="16" y1="17" x2="8" y2="17"/>
      <polyline points="10 9 9 9 8 9"/>
    </svg>
    Resume Preview
  </button>
</div>

<div id="pdfModal" class="pdf-modal">
  <div class="pdf-modal-content">
    <div class="pdf-modal-header">
      <h2>Resume Preview</h2>
      <button id="closeModal" class="close-modal-btn">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <line x1="18" y1="6" x2="6" y2="18"/>
          <line x1="6" y1="6" x2="18" y2="18"/>
        </svg>
      </button>
    </div>
    
    <div class="pdf-preview-area" id="pdfPreviewArea">
      <div class="pdf-content" id="pdfContent">
        <div class="pdf-header">
          <h1>Academic Resume</h1>
          <p class="pdf-subtitle">Professional Experience & Education</p>
        </div>
        <div id="pdfExperiencesList"></div>
      </div>
    </div>
    
    <div class="pdf-modal-footer">
      <button id="downloadPdfBtn" class="download-pdf-btn">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
          <polyline points="7 10 12 15 17 10"/>
          <line x1="12" y1="15" x2="12" y2="3"/>
        </svg>
        Download PDF
      </button>
    </div>
  </div>
</div>

<script>
  import jsPDF from 'jspdf';
  
  const resumePreviewBtn = document.getElementById('resumePreviewBtn') as HTMLButtonElement;
  const pdfModal = document.getElementById('pdfModal') as HTMLElement;
  const closeModalBtn = document.getElementById('closeModal') as HTMLButtonElement;
  const downloadPdfBtn = document.getElementById('downloadPdfBtn') as HTMLButtonElement;
  const pdfExperiencesList = document.getElementById('pdfExperiencesList') as HTMLElement;
  
  function getVisibleExperiences() {
    const cards = Array.from(document.querySelectorAll('.experience-card')) as HTMLElement[];
    return cards.filter(card => card.style.display !== 'none').map(card => ({
      title: card.querySelector('.experience-title')?.textContent || '',
      organization: card.querySelector('.experience-org')?.textContent || '',
      date: card.querySelector('.experience-date')?.textContent || '',
      description: card.querySelector('.experience-description')?.textContent || '',
      type: card.dataset.type || '',
      tags: (card.dataset.tags || '').split(',')
    }));
  }
  
  function updatePDFPreview() {
    const experiences = getVisibleExperiences();
    
    if (experiences.length === 0) {
      pdfExperiencesList.innerHTML = '<p class="no-experiences">No experiences to display. Adjust your filters to see results.</p>';
      return;
    }
    
    pdfExperiencesList.innerHTML = experiences.map(exp => `
      <div class="pdf-experience-item">
        <div class="pdf-exp-header">
          <div>
            <h3 class="pdf-exp-title">${exp.title}</h3>
            <p class="pdf-exp-org">${exp.organization}</p>
          </div>
          <span class="pdf-exp-date">${exp.date}</span>
        </div>
        <p class="pdf-exp-description">${exp.description}</p>
        <div class="pdf-exp-tags">
          ${exp.tags.map(tag => `<span class="pdf-tag">${tag}</span>`).join('')}
        </div>
      </div>
    `).join('');
  }
  
  function generatePDF() {
    const experiences = getVisibleExperiences();
    
    if (experiences.length === 0) {
      alert('No experiences to export. Please adjust your filters.');
      return;
    }
    
    const pdf = new jsPDF();
    const pageWidth = pdf.internal.pageSize.getWidth();
    const pageHeight = pdf.internal.pageSize.getHeight();
    const margin = 20;
    const maxWidth = pageWidth - (margin * 2);
    let yPosition = margin;
    
    // Header
    pdf.setFontSize(24);
    pdf.setFont('helvetica', 'bold');
    pdf.text('Academic Resume', margin, yPosition);
    yPosition += 10;
    
    pdf.setFontSize(10);
    pdf.setFont('helvetica', 'normal');
    pdf.setTextColor(100, 100, 100);
    pdf.text('Professional Experience & Education', margin, yPosition);
    yPosition += 15;
    
    // Experiences
    experiences.forEach((exp, index) => {
      // Check if we need a new page
      if (yPosition > pageHeight - 40) {
        pdf.addPage();
        yPosition = margin;
      }
      
      // Type badge
      pdf.setFontSize(8);
      pdf.setFont('helvetica', 'bold');
      pdf.setTextColor(96, 165, 250);
      pdf.text(exp.type.toUpperCase(), margin, yPosition);
      
      // Date
      pdf.setTextColor(150, 150, 150);
      pdf.text(exp.date, pageWidth - margin - 40, yPosition);
      yPosition += 7;
      
      // Title
      pdf.setFontSize(12);
      pdf.setFont('helvetica', 'bold');
      pdf.setTextColor(0, 0, 0);
      pdf.text(exp.title, margin, yPosition);
      yPosition += 6;
      
      // Organization
      pdf.setFontSize(10);
      pdf.setFont('helvetica', 'normal');
      pdf.setTextColor(80, 80, 80);
      const orgText = exp.organization.replace(/\s*•\s*/g, ' - ');
      pdf.text(orgText, margin, yPosition);
      yPosition += 6;
      
      // Description
      pdf.setFontSize(9);
      pdf.setTextColor(60, 60, 60);
      const descLines = pdf.splitTextToSize(exp.description, maxWidth);
      pdf.text(descLines, margin, yPosition);
      yPosition += (descLines.length * 5) + 5;
      
      // Tags
      if (exp.tags.length > 0 && exp.tags[0] !== '') {
        pdf.setFontSize(8);
        pdf.setTextColor(120, 120, 120);
        const tagsText = exp.tags.join(' • ');
        pdf.text(tagsText, margin, yPosition);
        yPosition += 8;
      }
      
      // Separator line
      if (index < experiences.length - 1) {
        pdf.setDrawColor(220, 220, 220);
        pdf.line(margin, yPosition, pageWidth - margin, yPosition);
        yPosition += 8;
      }
    });
    
    // Footer
    const totalPages = pdf.internal.pages.length - 1;
    for (let i = 1; i <= totalPages; i++) {
      pdf.setPage(i);
      pdf.setFontSize(8);
      pdf.setTextColor(150, 150, 150);
      pdf.text(
        `Page ${i} of ${totalPages}`,
        pageWidth / 2,
        pageHeight - 10,
        { align: 'center' }
      );
    }
    
    pdf.save('academic-resume.pdf');
  }
  
  resumePreviewBtn.addEventListener('click', () => {
    updatePDFPreview();
    pdfModal.style.display = 'flex';
    document.body.style.overflow = 'hidden';
  });
  
  closeModalBtn.addEventListener('click', () => {
    pdfModal.style.display = 'none';
    document.body.style.overflow = 'auto';
  });
  
  pdfModal.addEventListener('click', (e) => {
    if (e.target === pdfModal) {
      pdfModal.style.display = 'none';
      document.body.style.overflow = 'auto';
    }
  });
  
  downloadPdfBtn.addEventListener('click', generatePDF);
  
  // Listen for filter changes to update preview
  const searchInput = document.getElementById('searchInput');
  const typeFilter = document.getElementById('typeFilter');
  const tagFilter = document.getElementById('tagFilter');
  
  if (searchInput) searchInput.addEventListener('input', () => {
    if (pdfModal.style.display === 'flex') {
      updatePDFPreview();
    }
  });
  
  if (typeFilter) typeFilter.addEventListener('change', () => {
    if (pdfModal.style.display === 'flex') {
      updatePDFPreview();
    }
  });
  
  if (tagFilter) tagFilter.addEventListener('change', () => {
    if (pdfModal.style.display === 'flex') {
      updatePDFPreview();
    }
  });
</script>

<style>
  .pdf-preview-container {
    margin-bottom: var(--spacing-lg);
  }
  
  .resume-preview-btn {
    display: inline-flex;
    align-items: center;
    gap: var(--spacing-sm);
    padding: var(--spacing-md) var(--spacing-xl);
    background-color: var(--color-primary);
    color: var(--color-background);
    border: none;
    border-radius: var(--radius-md);
    font-size: 1rem;
    font-weight: 600;
    cursor: pointer;
    transition: all var(--transition-base);
  }
  
  .resume-preview-btn:hover {
    background-color: #5b9ee0;
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(96, 165, 250, 0.3);
  }
  
  .pdf-modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.8);
    z-index: 1000;
    align-items: center;
    justify-content: center;
    padding: var(--spacing-lg);
  }
  
  .pdf-modal-content {
    background-color: var(--color-background);
    border-radius: var(--radius-lg);
    width: 100%;
    max-width: 900px;
    max-height: 90vh;
    display: flex;
    flex-direction: column;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
  }
  
  .pdf-modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: var(--spacing-xl);
    border-bottom: 1px solid var(--color-border);
  }
  
  .pdf-modal-header h2 {
    margin: 0;
    color: var(--color-text-primary);
  }
  
  .close-modal-btn {
    background: none;
    border: none;
    color: var(--color-text-secondary);
    cursor: pointer;
    padding: var(--spacing-sm);
    border-radius: var(--radius-sm);
    transition: all var(--transition-fast);
  }
  
  .close-modal-btn:hover {
    background-color: var(--color-surface);
    color: var(--color-text-primary);
  }
  
  .pdf-preview-area {
    flex: 1;
    overflow-y: auto;
    padding: var(--spacing-xl);
    background-color: var(--color-surface);
  }
  
  .pdf-content {
    background-color: white;
    padding: var(--spacing-2xl);
    border-radius: var(--radius-md);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    max-width: 800px;
    margin: 0 auto;
  }
  
  .pdf-header {
    text-align: center;
    margin-bottom: var(--spacing-2xl);
    padding-bottom: var(--spacing-xl);
    border-bottom: 2px solid #e5e7eb;
  }
  
  .pdf-header h1 {
    color: #1f2937;
    margin-bottom: var(--spacing-sm);
    font-size: 2rem;
  }
  
  .pdf-subtitle {
    color: #6b7280;
    font-size: 1rem;
  }
  
  .pdf-experience-item {
    margin-bottom: var(--spacing-xl);
    padding-bottom: var(--spacing-xl);
    border-bottom: 1px solid #e5e7eb;
  }
  
  .pdf-experience-item:last-child {
    border-bottom: none;
  }
  
  .pdf-exp-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: var(--spacing-sm);
    gap: var(--spacing-md);
  }
  
  .pdf-exp-title {
    color: #1f2937;
    font-size: 1.15rem;
    margin-bottom: 0.25rem;
  }
  
  .pdf-exp-org {
    color: #6b7280;
    font-size: 0.95rem;
    margin: 0;
  }
  
  .pdf-exp-date {
    color: #9ca3af;
    font-size: 0.85rem;
    font-family: var(--font-mono);
    white-space: nowrap;
  }
  
  .pdf-exp-description {
    color: #4b5563;
    font-size: 0.95rem;
    line-height: 1.6;
    margin-bottom: var(--spacing-sm);
  }
  
  .pdf-exp-tags {
    display: flex;
    flex-wrap: wrap;
    gap: var(--spacing-xs);
  }
  
  .pdf-tag {
    font-size: 0.75rem;
    padding: 0.25rem 0.5rem;
    background-color: #f3f4f6;
    color: #6b7280;
    border-radius: var(--radius-sm);
  }
  
  .no-experiences {
    text-align: center;
    color: #9ca3af;
    padding: var(--spacing-2xl);
  }
  
  .pdf-modal-footer {
    padding: var(--spacing-xl);
    border-top: 1px solid var(--color-border);
    display: flex;
    justify-content: flex-end;
  }
  
  .download-pdf-btn {
    display: inline-flex;
    align-items: center;
    gap: var(--spacing-sm);
    padding: var(--spacing-md) var(--spacing-xl);
    background-color: var(--color-primary);
    color: var(--color-background);
    border: none;
    border-radius: var(--radius-md);
    font-size: 1rem;
    font-weight: 600;
    cursor: pointer;
    transition: all var(--transition-base);
  }
  
  .download-pdf-btn:hover {
    background-color: #5b9ee0;
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(96, 165, 250, 0.3);
  }
  
  @media (max-width: 768px) {
    .pdf-modal-content {
      max-height: 95vh;
    }
    
    .pdf-content {
      padding: var(--spacing-lg);
    }
    
    .pdf-exp-header {
      flex-direction: column;
    }
    
    .pdf-exp-date {
      align-self: flex-start;
    }
  }
</style>